## instructor: Anthony Alicea
## class: Learn and Understand NodeJS
- This is 6 years old class - node.js v4.0.0 is used
- Current (Dec 2021) version of Node.js is v12.22

9. Adding features to Javascript
- Showing bytecode from node.js CLI
```console
node --print-bytecode
> 1+1
[generated bytecode for function:  (0x3342e772a171 <SharedFunctionInfo>)]
Parameter count 1
Register count 1
Frame size 8
    0 E> 0x3342e772a1ee @    0 : a7                StackCheck 
    0 S> 0x3342e772a1ef @    1 : 0c 02             LdaSmi [2]
         0x3342e772a1f1 @    3 : 26 fb             Star r0
    4 S> 0x3342e772a1f3 @    5 : ab                Return 
Constant pool (size = 0)
Handler Table (size = 0)
```
- Users can provide user-defined C++ functions to node.js

17. First class functions
- Ref: https://www.developintelligence.com/blog/2016/10/javascript-functions-as-first-class-objects/

18. Modules
- greet.js 
```JS
function greet() {
 console.log('hello');
}
module.exports = greet;
```
- app.js 
```JS
let newf = require('./greet.js')
$ node ./app.js
hello
```

20. Inheritance
- Using prototype keyword
```js
function Person(fName, lName) {
    this.fName = fName;
    this.lName = lName;
}
Person.prototype.greet = ()=> {
    console.log('Hello ' + this.fName + ' ' + this.lName);
}
let john = new Person('John', 'Doe');
let jane = new Person('Jane', 'Doe');
john.greet();
jane.greet();
```
- As greet() is added into prototype, all instances have that function

23. How module works?
- Investigation of the internal of node.js through debugger
- Reads module export function using IIFE
![wrap_require](./wrap_module.png)

25. Require example
- req.js
```JS
let greet_en = () => { console.log('hello');};
let greet_sp = () => { console.log('hola');};
module.exports = {
    english: greet_en,
    spanish: greet_sp
};
```
- app.js
```JS
let greetings = require('./req')
greetings.english();
greetings.spanish();
```
- Command:
```bash
$ node sec25.js 
hello
hola
```

27. exports vs module.exports
- Ref: https://www.sitepoint.com/understanding-module-exports-exports-node-js/
- Ref: https://stackoverflow.com/questions/16383795/difference-between-module-exports-and-exports-in-the-commonjs-module-system
- Use module.exports

28. core modules
- no slash in the require()
```
let util=require('util');
console.log(util.format('hello %s','world'));
```
- `util.log()` is deprecated

31. Events
- System events - C++ core through libuv
- Custom events - javascript core or my code through Event Emitter
    - We don't see event emitter

33. Node Event Emitter
- sec33.js
```js
class Emitter {
    events = {};
}
Emitter.prototype.on = function(type, listener)  {
    this.events[type] = this.events[type] || [];
    this.events[type].push(listener);
}
Emitter.prototype.emit = function(type) {
    if (this.events[type]) {
        this.events[type].forEach(function(listener) {
            listener();
        });
    }
};
module.exports = Emitter
```
- app.js
```js
let Emitter = require('./sec33');
//let Emitter = require('events')
let emtr = new Emitter();
emtr.on('greet', ()=>{console.log('someone said hello');})
emtr.on('greet', ()=>{console.log('a greeting occured');})
emtr.emit('greet')
console.log(emtr.__proto__)
```
- Registered 'greet' as event type. When 'greet' is triggered or injected, it runs the pushed listener functions.
- multiple functions are allowed as they are pushed into array. Those functions are executed along forEach()

34. Events in node.js
- https://nodejs.org/api/events.html
- In source, node-master/lib/events.js
    - Same approach of section 33.
    - Replacing `let Emitter = require('./sec33');` with `let Emitter = require('events')` still works

36. Inheriting
- Using `util.inherits()` -> now in ES6, it is not recommended.

40. Class
- `class` is a syntactic sugar
- The instructor is a fan of prototype, not class

42. async code
- Javascript is synchronous
- Node.js is asynchronous

44. libuv
- libuv checks queue periodically, checking event loops
- libuv.org
    - Written in C

47. Buffers
```js
let bf = new Buffer.from('hello','utf-8')
console.log(bf);
console.log(bf.toString());
console.log(bf.toJSON());
```
- Command
```bash
$ node sec47.js 
<Buffer 68 65 6c 6c 6f>
hello
{ type: 'Buffer', data: [ 104, 101, 108, 108, 111 ] }
```

48. ES6 typed arrays
```js
let bf = new ArrayBuffer(8); // 8 bytes
let ia = new Int32Array(bf);
console.log(ia);
ia[0] = 453;
ia[1] = 123456;
console.log(ia);
```
- Command
```bash
$ node sec48.js 
Int32Array(2) [ 0, 0 ]
Int32Array(2) [ 453, 123456 ]
```
- bf is assigned with 8 bytes. As int32 is 4bytes, it can be converted as 2 element array

50. File system (fs)
```js
let fs = require('fs'); 
let greet = fs.readFileSync(__dirname + '/greet.txt', 'utf8');
console.log(greet);
fs.readFile(__dirname + '/greet.txt','utf8', 
    (err,data)=>{console.log("callback:"+data)}); // returns nothing
console.log("end of the code")
```
- fs.readFileSync() reads the file and stores into the buffer first. Returns the content of the file
    - Check node-master/lib/fs.js 
- fs.readFile() has an Error First Callback as an argument. Returns nothing
- Error First Callback: call backs take an error object as their first argument
    - When there is no error, null goes
- Command:
```
$ node sec50.js 
hello world!!!

end of the code
callback:hello world!!!
```
- callback message is after the end of the code as async

51. Streams
- Streams is inherited from EventEmitter
```js
let fs = require('fs');
let readable = fs.createReadStream(__dirname + '/syslog', 
                                    {encoding: 'utf8', 
                                    highWaterMark: 16*1024});
readable.on('data',function(chunk) {console.log(chunk.length);});
```
- Result
```
$ node sec51.js
16384
16384
16384
16384
16384
16384
12987
```
- chunked by 16kbytes

52. Pipes
- Connecting from one readable stream to other writable stream
```js
let fs = require('fs');
let zlib = require('zlib');
let readable = fs.createReadStream(__dirname + '/syslog', 
                                    {encoding: 'utf8', 
                                    highWaterMark: 16*1024});
let writable = fs.createWriteStream(__dirname + '/write1.txt');
readable.on('data',function(chunk) {
    console.log(chunk.length);
    writable.write(chunk);
});
// Using pipe
let writable2 = fs.createWriteStream(__dirname + '/write2.txt');
readable.pipe(writable2)
// Using pipe + gzip
let gzip = zlib.createGzip();
let compressed = fs.createWriteStream(__dirname + '/write3.txt.gz'); // need to use gunzip, not unzip
readable.pipe(gzip).pipe(compressed);
```
