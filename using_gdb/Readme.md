# Sample video from Learn Linux User Space Debugging in Udemy
- source code
```cpp
#include <iostream>
#include <cmath>
double comp(int i, int j) {
  return static_cast<double> (i*j);
}
int main() {
  double x;
  x = comp(3,4);
  std::cout << "x = " << x << std::endl;
}
```
- Debug with arguments: `gdb --args a.exe arg1 arg2 arg3 ...  `
  - Or in the gdb: `run  arg1 arg2 arg3 ...`
    - or may use `set args`
- Some keywords
  - `info functions`: enlists available functions
  - `break main`: injects a break point main
  - `b 9`: adds a break point at line 9
  - `info breakpoints`: enlists the breakpoints
  - `next`: next line
  - `step`: will step into a function
  - `continue`: continues up to the next break point
  - `finish`: finishes the current function
  - `list`: shows the code shot
- Sample screen shot
```bash
(gdb) info functions
All defined functions:

File ex1.cxx:
double comp(int, int);
int main();
static void _GLOBAL__sub_I__Z4compii();
static void __static_initialization_and_destruction_0(int, int);
...
(gdb) break main
Breakpoint 1 at 0x929: file ex1.cxx, line 8.
(gdb) b 9
Breakpoint 2 at 0x941: file ex1.cxx, line 9.
(gdb) info breakpoints
Num     Type           Disp Enb Address            What
1       breakpoint     keep y   0x0000000000000929 in main() at ex1.cxx:8
2       breakpoint     keep y   0x0000000000000941 in main() at ex1.cxx:9
(gdb) list
4	  return static_cast<double> (i*j);
5	}
6	int main() {
7	  double x;
8	  x = comp(3,4);
9	  std::cout << "x = " << x << std::endl;
10	}(gdb) 
```
- When an executable crashes in the gdb
  - `backtrace`
    - #1/#2/#3 ...: they are frame numbers
  - `frame 3`: selects frame 3
  - `p j`: prints the value of j
  - `p /x j`: prints in hexa
  - `p /t j`: prints in binary
  - `x &j`: shows the memory of j
  - `ptype j`: the type of j
  - `set j=3`: replaces the value of j as 3
```bash
(gdb) run
Starting program: /home/hpjeon/hw/class/udemy_gdb/a.out 

Program received signal SIGFPE, Arithmetic exception.
0x0000555555554918 in comp (i=3, j=0) at ex2.cxx:4
4	  return static_cast<double> (i/j);
(gdb) backtrace
#0  0x0000555555554918 in comp (i=3, j=0) at ex2.cxx:4
#1  0x0000555555554938 in main () at ex2.cxx:8
(gdb) frame 0
#0  0x0000555555554918 in comp (i=3, j=0) at ex2.cxx:4
4	  return static_cast<double> (i/j);
(gdb)  x &i
0x7fffffffd57c:	00000000000000000000000000000011
(gdb) ptype i
type = int
```

## Using core dump file
- Youtube: Core dump Analysis for Linux Application Debugging Part1 www rulingminds com
- How to decode core files
- Source code
```cpp
#include <iostream>
#include <cmath>
double comp(int i, int j) {
  return static_cast<double> (i/j);
}
int main() {
  double x;
  x = comp(3,0);
  std::cout << "x = " << x << std::endl;
}
```
- `man signal`: Check which SIGNAL will be generated through core files
- `man setrlimit`: Can configure the size of core files
- `ulimit -c unlimited`: unlimited size of core files
- `file core`: status of core file
- `objdump -h core`: shows segments
- `gdb ./a.out core`: loading core file
  - Will show the location of termination and SIGNAL
- GDB command:
  - `disassemble`: shows the assembler code where the problem is found
  - `info registers`: shows values of current registers
  - `bt`: backtrace. Can find the frame number. Same as `where` or `info stack`
  - `info frame`: status of the frame. Can find the address of Arglist and Locals
    - `Arglist at 0x7ffc5c0634d0`
    - `Locals at 0x7ffc5c0634d0`: this would batch of $rbp (or $ebp at 32bit OS)
  - `x/10xw $rbp-0x8`: prints the raw memory of `-0x8(%rbp)`
    - Find the address who called me
  - `info symbol 0x5c063500`: shows which symbol matches. Find the section number and find the corresponding section from disassemble
```
$ file core
core: ELF 64-bit LSB core file x86-64, version 1 (SYSV), SVR4-style, from './a.out', real uid: 1000, effective uid: 1000, real gid: 1000, effective gid: 1000, execfn: './a.out', platform: 'x86_64'
$ objdump -h core
core:     file format elf64-x86-64
Sections:
Idx Name          Size      VMA               LMA               File off  Algn
  0 note0         00000ebc  0000000000000000  0000000000000000  00000740  2**0
                  CONTENTS, READONLY
  1 .reg/26611    000000d8  0000000000000000  0000000000000000  000007c4  2**2
                  CONTENTS
  2 .reg          000000d8  0000000000000000  0000000000000000  000007c4  2**2
                  CONTENTS
  3 .note.linuxcore.siginfo/26611 00000080  0000000000000000  0000000000000000  00000954  2**2
                  CONTENTS
...
$ gdb ./a.out core
...
Core was generated by `./a.out'.
Program terminated with signal SIGFPE, Arithmetic exception.
#0  0x0000560c710ba918 in comp (i=3, j=0) at ex2.cxx:4
4	  return static_cast<double> (i/j);
(gdb) disassemble
Dump of assembler code for function comp(int, int):
   0x0000560c710ba90a <+0>:	push   %rbp
   0x0000560c710ba90b <+1>:	mov    %rsp,%rbp
   0x0000560c710ba90e <+4>:	mov    %edi,-0x4(%rbp)
   0x0000560c710ba911 <+7>:	mov    %esi,-0x8(%rbp)
   0x0000560c710ba914 <+10>:	mov    -0x4(%rbp),%eax
   0x0000560c710ba917 <+13>:	cltd   
=> 0x0000560c710ba918 <+14>:	idivl  -0x8(%rbp)
   0x0000560c710ba91b <+17>:	cvtsi2sd %eax,%xmm0
   0x0000560c710ba91f <+21>:	pop    %rbp
   0x0000560c710ba920 <+22>:	retq   
End of assembler dump.
(gdb) info registers
rax            0x3	3
rbx            0x0	0
rcx            0xa0	160
rdx            0x0	0
...
(gdb) bt
#0  0x0000560c710ba918 in comp (i=3, j=0) at ex2.cxx:4
#1  0x0000560c710ba938 in main () at ex2.cxx:8
(gdb) info frame
Stack level 0, frame at 0x7ffc5c0634e0:
 rip = 0x560c710ba918 in comp (ex2.cxx:4); saved rip = 0x560c710ba938
 called by frame at 0x7ffc5c063510
 source language c++.
 Arglist at 0x7ffc5c0634d0, args: i=3, j=0
 Locals at 0x7ffc5c0634d0, Previous frame's sp is 0x7ffc5c0634e0
 Saved registers:
  rbp at 0x7ffc5c0634d0, rip at 0x7ffc5c0634d8
(gdb) p $rbp
$3 = (void *) 0x7ffc5c0634d0
(gdb) x/10xw $rbp-0x8
0x7ffc5c0634c8:	0x00000000	0x00000003	0x5c063500	0x00007ffc
0x7ffc5c0634d8:	0x710ba938	0x0000560c	0x710ba9f0	0x0000560c
0x7ffc5c0634e8:	0x710ba800	0x0000560c
```

## Nitty-gritty
- Whe a core file is not generated even though there is a message syaing core dumped
  - https://stackoverflow.com/questions/2065912/core-dumped-but-core-file-is-not-in-the-current-directory
```
$ sudo service apport stop
...
$ ./a.out 
Floating point exception (core dumped)
$ ls -alrt
...
-rw-------  1 hpjeon hpjeon 495616 Aug  5 09:40 core # --> now found
```
- Regarding Apport
  - https://wiki.ubuntu.com/Apport
- Check the address of -0x4(%rbp)
  - https://stackoverflow.com/questions/5455832/how-to-print-0x4rbp-in-gdb
  - p $rbp-0x4
  - x /w $rbp-0x4

## TUI at GDB
- CppCon 2015: Greg Law " Give me 15 minutes & I'll change your view of GDB" from Youtube
- ctl+x,a
- ctl+x,2
```
   ┌──ex2.cxx─────────────────────────────────────────────────────────────────────────────┐
  >│4         return static_cast<double> (i/j);                                           │
   │5       }                                                                             │
   │6       int main() {                                                                  │
   │7         double x;                                                                   │
   │8         x = comp(3,0);                                                              │
   │9         std::cout << "x = " << x << std::endl;                                      │
   └──────────────────────────────────────────────────────────────────────────────────────┘
  >│0x560c710ba918 <comp(int, int)+14>      idivl  -0x8(%rbp)                             │
   │0x560c710ba91b <comp(int, int)+17>      cvtsi2sd %eax,%xmm0                           │
   │0x560c710ba91f <comp(int, int)+21>      pop    %rbp                                   │
   │0x560c710ba920 <comp(int, int)+22>      retq                                          │
   │0x560c710ba921 <main()>                 push   %rbp                                   │
   │0x560c710ba922 <main()+1>               mov    %rsp,%rbp                              │
   └──────────────────────────────────────────────────────────────────────────────────────┘
core LWP 26611 In: comp                                           L4    PC: 0x560c710ba918 
(gdb) 5 in /home/hpjeon/hw/class/udemy_gdb/ex2.cxx
(gdb) 
```
